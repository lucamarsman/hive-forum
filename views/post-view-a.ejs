<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title> Homepage </title>
  <link rel="stylesheet" type="text/css" href="/public/assets/styles.css" title="style" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

  <div id = "main">
    <header id = "main-nav">
      <button id = "btn1" onclick="window.location.href='/profile'">Profile</button>
      <button id = "btn2" onclick="window.location.href='/logout'">Logout</button>
    </header>
  </div>

<div id="login-pop">

    <div id="post-data">
    <h1 id="title"><%= title %></h1>
    <p id="content"><%= body %></p>
    <p id="timestamp"><%= timestamp %></p>
    </div>

    <div id = "new-comment">
      <form action="" id = "comment-form" method = "POST">
      <textarea id ="newcomment" maxlength="500" name="comment"></textarea>
      <button id="post-comment" type = "submit" onclick="window.location.href='/new-comment'">Post</button>
      </form>
    </div>

    <div id="comments">
      <div id="commentsContainer"></div>
    </div>

</div>

<script>
  let currentPage = 1;
  let isLoading = false;
  let morePostsAvailable = true;  // New flag to check if more posts are left

function debounce(fn, delay) {
 let timer;
 return function() {
     clearTimeout(timer);
     timer = setTimeout(() => {
         fn();
     }, delay);
 };
}

function nearBottomOfPage() {
 return (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500;
}

function loadPosts() {
 if (isLoading || !morePostsAvailable) return;

 isLoading = true;

 const loadingIndicator = document.createElement("div");
 loadingIndicator.textContent = "Loading...";
 loadingIndicator.id = "loading-indicator";
 comments.appendChild(loadingIndicator);

 console.log(comments)

 fetch(`/api/comments?page=${currentPage}`)
     .then(response => response.json())
     .then(comments => {
         isLoading = false;
         if (comments.length > 0) {
             comments.forEach(comment => {
                 const commentElement = document.createElement("div");
                 commentElement.classList.add("post-item");
                 commentElement.setAttribute("data-post-id", comment.post_id);

                 const commentContent = document.createElement("p");
                 commentContent.textContent = comment.content;
                 const commentTimestamp = document.createElement("p");
                 commentTimestamp.textContent = comment.timestamp;

                 commentElement.appendChild(commentContent);
                 commentElement.appendChild(commentTimestamp);

                 commentsContainer.appendChild(commentElement);
             });
             currentPage++;
             
             const loadingIndicator = document.getElementById("loading-indicator");
             if (loadingIndicator) {
                loadingIndicator.remove();
             }
             
         } else {
             morePostsAvailable = false; // No more posts left to fetch
             const loadingIndicator = document.getElementById("loading-indicator");
             if (loadingIndicator) {
                loadingIndicator.remove();
             }
         }
     })
     .catch(error => {
         isLoading = false;
         console.error('Failed to fetch posts:', error);

         const loadingIndicator = document.getElementById("loading-indicator");
         if (loadingIndicator) {
             loadingIndicator.remove();
         }
     });
}

document.addEventListener('DOMContentLoaded', function() {
 const commentsContainer = document.getElementById("commentsContainer");
 //add click event here

 // Debounce the onScroll function to optimize performance
 document.addEventListener('scroll', debounce(() => {
     if (nearBottomOfPage()) {
         loadPosts();
     }
 }, 100));

 loadPosts(); // Load the initial posts
});
</script>

</body>
</html>